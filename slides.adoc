= All-in sur la plateforme : Nouveau Poker @Betclic !
:imagesdir: images
:source-highlighter: highlightjs
:revealjs_theme: white
:revealjs_history: true
:revealjs_slideNumber: true
:revealjs_totalTime: 2700
:customcss: custom.css
:icons: font
:title-slide-transition: zoom
//:title-slide-background-image: landing_hero_desktop.webp
// devoxx.png
:conf: landing_hero_desktop.webp

image:{conf}[width=100%]
â™£ï¸â™¦ï¸â™ ï¸â™¥ï¸ 

++++
<script type="text/javascript">
window.addEventListener("load", function() {

revealDiv = document.querySelector("body div.reveal")
footer = document.getElementById("custom-footer");
revealDiv.appendChild(footer);

} );
</script>
<div id="custom-footer" class="footer">
  <img src="images/betclic.png"/>
</div>
++++

== Contexte

[%step]
* Poker white label __Betclic__ ğŸ·ï¸
* Propre plateforme ğŸ†•
** ÃŠtre autonome ğŸ’ª, rÃ©actif âš¡
* Moderniser le Poker âœ¨ ğŸ®

== Ambition

* ğŸ†• Plateforme de Poker & App. cross-devices 
* *09/2023*
** Lancement du projet ğŸš€
** NDA public & _interne_ ğŸ¤
** 1 squad, 10 personnes (8 devs) ğŸ¥·
* *??/????*
** Mise en prod ğŸ¯
**  3 squads, 60 personnes (40 devs) ğŸ“ˆ

== Poker Room

[%step]
* ComplexitÃ© mÃ©tier â™£ï¸â™¦ï¸â™ ï¸â™¥ï¸ 
* ComplexitÃ© technique
** Gaming temps rÃ©el
** Concurrence
** Pv__Betclic__ -> âœ¨PvPâœ¨

== Choix forts

[%step]
* Sur l'Ã©tagÃ¨re ğŸ“¦ (SaaS, PaaS)
* Archi Âµservices hexa (mix DDD)
* `Kotlin` + `Ktor`
* ImmutabilitÃ© ğŸª¨
* API first ğŸ“ƒğŸ™
* CQRS + Events ğŸ“§

== Kotlin

* Moderne, haut niveau
* Concis ğŸª„
* Null safe (compile time) ğŸ‘‹ğŸ’£
* Fonctionnel
* DÃ©courage mutabilitÃ©, hÃ©ritage ğŸ™

== ImmutabilitÃ© ğŸª¨

[source, kotlin]
----
// mutable
class Table(
  val id: TableId,
  val players: MutableList<Player>,
) {
   fun seat(player: Player) {
       players.add(player)
   }
}
----

[%step]
[source, kotlin]
----
// immutable
data class Table(
  val id: TableId,
  val players: List<Player>,
) {
   fun seat(player: Player): Table {
       return copy(players = players + player)
   }
}
----

== Invariants ğŸš«

[source, kotlin]
----
class Table(
  val id: TableId,
  val players: MutableList<Player>, // mutable
  val config: TableConfig,
) {
   fun seat(player: Player) {
      with(config) {
        check(players.size in minPlayers..maxPlayers)
        check(players.distinctBy { it.tablePosition }.size == players.size)
      }
      players.add(player)
   }

   fun lastPlayerLeaves() {
      with(config) {
        check(players.size in config.minPlayers..config.maxPlayers)
      }
      players.removeLast()
   }
}
----

== Invariants ğŸš«

[source, kotlin]
----
data class Table(
    val id: TableId,
    val players: List<Player>, // immutable
    val config: TableConfig,
) {
   init {
     with(config) {
       check(players.size in minPlayers..maxPlayers)
       check(players.distinctBy { it.tablePosition }.size == players.size)
     }
   }

   fun seat(player: Player): Table =
      copy(players = players + player)

   fun lastPlayerLeaves(): Table =
      copy(players = players.dropLast(1))
}
----

== Null

* Kotlin, compilation âœ…
* L'absence de prÃ©sence

[source, kotlin]
----
data class RewardPoints(val value: Int)

// use case
interface RewardPlayer {
  fun endGameRewardFor(player: Player): RewardPoints?
}

...
rewardPlayer.endGameRewardFor(player) == null // ğŸ¤”
...
----

== Sealed interfaces/classes

NullObject pattern

[source, kotlin]
----
// use case
interface RewardPlayer {
  fun endGameRewardFor(player: Player): Reward
}

sealed interface Reward {
  data object NotEnoughGameTime : Reward
  data class PlayerNotElligible(reason: Reason) : Reward
  data class Points(val value: Int) : Reward
}
----

[%step]
[source, kotlin]
----
val reward = rewardPlayer.endGameRewardFor(player)
// exhaustive when
when (reward) {
  is NotEnoughGameTime -> println("Needs to play more!")
  is PlayerNotElligible -> println("Not eligible: $reason!")
  is Points -> println("Player won ${reward.value} points!")
  // no else, no default
}
----

== Value classes

* donner un sens mÃ©tier aux valeurs
* fonctions opÃ©rateurs
* ğŸ§® commutatif, associatif, distributif
* ğŸ”‘ invariants

== Value classes ğŸª™

[source, kotlin]
----
@JvmInline
value class Chips(val value: Long) : Comparable<Chips> {
  init {
    require(value >= 0) { "Chips cannot be negative" }
  }

  operator fun plus(chips: Chips): Chips = 
    Chips(value + chips.value)
  operator fun minus(chips: Chips): Chips = 
    Chips(value - chips.value)
  operator fun times(factor: Int): Chips = 
    Chips(value * factor)
  override fun compareTo(other: Chips): Int = 
    value.compareTo(other.value)
}
----

[%step]
[source, kotlin]
----
123.chips >= 42.chips // true
123.chips in 100.chips..200.chips // true
123.chips + 42.chips == 165.chips
123.chips - 888.chips // ğŸ’¥ IllegalArgumentException
----

== Value classes ğŸª™

[source, kotlin]
----
@JvmInline
value class Chips(val value: Long) : Comparable<Chips> {
  init {
    require(value >= 0) { "Chips cannot be negative" }
  }
  @Deprecated("Don't use div: splitBy()!", level = ERROR)
  operator fun div(divider: Int): Chips = 
    throw NotImplementedError()

  fun splitBy(divider: Int): WholeAndRemainder {
    require(divider > 0)
    val whole = Chips(value / divider)
    val remainder = Chips(value % divider)
    return WholeAndRemainder(whole, remainder)
  }
)
----

[%step]
image:div_deprecated.png[width=90%]

== Value classes ğŸª™

[source, kotlin]
----
fun split(pot: Chips, players: List<Player>)
    : Map<Player, Chips>
{
  val (whole, remainder) = pot.splitBy(players.size) // âœ…
  return players.associateWith { whole } 
    + (players.last() to (whole + remainder))
}
----

[source, kotlin]
----
7 splitBy 3 == WholeAndRemainder(whole = 2, remainder = 1)

//             ğŸ§‘â€ğŸ¦°  ğŸ‘±ğŸ¾    ğŸ§‘â€ğŸ¦²
//            ğŸŸ¢ğŸŸ¢ ğŸŸ¢ğŸŸ¢ ğŸŸ¢ğŸŸ¢ğŸŸ¡
----

== ProblÃ©matiques techniques

* Jeu temps rÃ©el
** Bidirectionnel ğŸŒ <--> ğŸ’»/ğŸ“±
** Latence
** Animations, timings gÃ©rÃ©s par le serveur
* Optimisations infrastructure
** RÃ©seau performant
** Nombreuses connections
** RentabilitÃ© hardware

[.columns.is-vcentered]
== Jeu temps rÃ©el â²ï¸

[.column]
image:grpc.png[width=80%]

*VS.*

[.column]
image:websockets.png[width=45%] +
WebSockets +

== Protocoles

|===
|gRPC |WebSockets 

|+ performance (binaire)
|- verbeux (JSON)

|- jeune Ã©cosystÃ¨me
|+ rÃ©pandu (ğŸ‘¨â€ğŸ¦³, outillage)

|- âŒ navigateur (2023)
|+ âœ… tous clients

|- ğŸ˜“ broadcast
|+ ğŸ™ broadcast
|===

== Ktor

* âŒ Framework
* ğŸª¶ Light
* âˆ¥ Coroutines
* ğŸ“¦ WebSocket, HTTP2 
** server/client engine**s**
* â­ï¸ gRPC/protobuf

== AWS GameLift ğŸ®

* `Fleet` (cycle de vie & scaling des GameServers)
* `FlexMatch` (matchmaking des joueurs)

[%notitle]
== Architecture

image::poker-archi.drawio.png[background, size=contain]

== â•/â– instances

* icon:server[] Ã— n Tables -> stateful
* Mise Ã  l'Ã©chelle ?
* Rolling updates ?

== Rolling updates

////
sequenceDiagram
    autonumber
    participant CI as CI/CD
    participant OLD as instance N
    participant FL as AWS Fleet
    CI ->> FL: v. N+1
    activate FL
    create participant NEW as instance N+1
    FL -->> NEW: ğŸ†•
    FL -->> NEW: AVAILABLE
    activate NEW
    FL -->> OLD: Refresh instance + UNAVAILABLE
    deactivate FL
    activate OLD
    loop pour chaque table
      OLD -->> OLD: Laisse table se finir
      OLD ->> FL: Deregister table finie
    end
    OLD ->> FL: Termine instance
    deactivate OLD
    destroy OLD
    FL -->> OLD: âŒ
    loop pour chaque table
      NEW -->> NEW: DÃ©marre table
      NEW ->> FL: Register table prÃªte
      deactivate NEW
    end
////

image:rolling_update.png[width=75%]

== RNG Service

== Flows

== CQRS

**C**ommand **Q**uery **R**esponsibility **S**egregation

== Table : CQRS + Events

////
flowchart BT
    subgraph domain
        Table -->|Invokes| Croupier
        TimeKeeper -->|Invokes| Croupier
        Table -->|Emits| ef([EventFlow]):::eventflow
        ef([EventFlow]) -. Consumes .-> TimeKeeper
        Croupier -->|Emits| cf([CommandQueryFlow]):::commandflow
        cf([CommandQueryFlow]) -. Consumes .-> Table
    end
    subgraph HTTP exposition
        HTTP -->|Queries| cf([CommandQueryFlow])
        cf([CommandQueryFlow]) -->|Responses| HTTP
    end
    subgraph WebSocket exposition
        Socket -->|Commands| cf([CommandQueryFlow])
        ef([EventFlow]) -. Consumes .-> Socket
    end
    subgraph game clients
        Client -->|WS Commands| Socket
        Socket -->|WS Events| Client
    end
    linkStyle 2,3,9 stroke: green;
    linkStyle 4,5,8 stroke: red;
    linkStyle 6,7 stroke: orange;
    classDef commandflow stroke: red;
    classDef eventflow stroke: green;
////

image:exposition-CQRS.png[width=68%]

== Timekeeper

== Optimisation Serveur (WS, Netty, Koin)

== Base de DonnÃ©es (DynamoDB -> PostgreSQL)

== Concurrence (non affinitÃ©)

[.columns.is-vcentered]
== Go live, mise en prod !

[.column]
*09/12/2024* +
1 an, 3 mois

[.column]
image::annonce_clubpoker.png[]

== Les abus â›”

[%step]
* _Tournois_ Enreg. tardif de masse ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦â€ğŸ‘¦âŒš
* _CashGame_ sÃ©lection des adversaires ğŸ”
* _Spin&Rush_ lancements en rafale ğŸ“ˆ

== Critiques passagÃ¨res

image:critics.gif[]

== Conclusion

image:early_app.png[width=30%]

[%notitle]
== Conclusion

image::table.jpg[background, size=contain]

[%notitle]
== Conclusion

video::desktop_demo.mov[width=100%, opts=autoplay,loop]

== Achievement unlocked ğŸ†

* 3 ğŸ”œ 4 modes de jeu
** _Spin&Rush_ 
** _CashGame_ (Texas Holdem, Omaha)
** _Tournois_ (MTT)
* PrÃ©vention / DÃ©tection
** Fraude
** Collusion
** Bots

== Achievement unlocked ğŸ†

* Back office (urgences, sanctions, ...)
* ConformitÃ© audits ANJ, Data analytics
* ObservabilitÃ©
* KPIs mÃ©tier
* SystÃ¨me de bots interne (tests)
* UX/Designers, QA tests autos/manuels ğŸ˜˜

== Cross-device frontend

* Flutter
** ğŸ“± iOS, Android
** ğŸ–¥ï¸ Windows, MacOS

== Chiffres

Donner des KPIs, avec l'aval/revue de Cyril

[.columns.is-vcentered]
== Questions ?

[.column]
image:avatar.jpg[width=90%]

[.column.is-two-thirds]
*Nicolas Comet* +
Senior Staff Software Engineer +
image:betclic.png[width=55%] +
Poker â™£ï¸â™¦ï¸â™ ï¸â™¥ï¸ +
icon:envelope[] nicolas.comet@gmail.com +
https://www.linkedin.com/in/nicolascomet[icon:linkedin[].com/nicolascomet] +
https://bsky.app/profile/ncomet.bsky.social[@ncomet.bsky.social] +
https://github.com/ncomet[icon:github[].com/ncomet] +

[%notitle]
== Votez ğŸ™

<QR code feedbacks>