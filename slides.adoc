= All-in sur la plateforme : Nouveau Poker @Betclic !
:imagesdir: images
:source-highlighter: highlightjs
:revealjs_theme: white
:revealjs_history: true
:revealjs_slideNumber: true
:revealjs_totalTime: 2700
:customcss: custom.css
:icons: font
:title-slide-transition: zoom
//:title-slide-background-image: landing_hero_desktop.webp
// devoxx.png
:conf: landing_hero_desktop.webp

image:{conf}[width=100%]
♣️♦️♠️♥️ 

++++
<script type="text/javascript">
window.addEventListener("load", function() {

revealDiv = document.querySelector("body div.reveal")
footer = document.getElementById("custom-footer");
revealDiv.appendChild(footer);

} );
</script>
<div id="custom-footer" class="footer">
  <img src="images/betclic.png"/>
</div>
++++

== Ambition

* 🆕 Appli cross-device, 🆕 Plateforme de poker
* *09/2023*
** Lancement du projet 🚀
** NDA public & _interne_ 🤐
** 1 squad, 10 personnes (8 devs) 🥷
* *12/2024*
** Mise en prod 🎯
**  3 squads, 60 personnes (40 devs) 📈

== Contexte Poker

[%step]
* Complexité métier ♣️♦️♠️♥️ 
* Complexité technique
** Gaming temps réel
** Concurrence
** Pv__Betclic__ -> ✨PvP✨

== Choix forts

[%step]
* Sur l'étagère 📦 (SaaS)
* Archi hexagonale (DDD)
* `Kotlin` + `Ktor`
* API first 🙏
* Immutabilité 🪨
* CQRS + Events 📧

== Kotlin

* Moderne, haut niveau 
* Concis 🪄
* Null safe (compile time) 👋💣
* Fonctionnel 
* Décourage mutabilité, héritage 🙏

== Immutabilité 🪨

[source, kotlin]
----
// mutable
class Table(
  val id: TableId,
  val players: MutableList<Player>,
) {
   fun seat(player: Player) {
       players.add(player)
   }
}
----

[%step]
[source, kotlin]
----
// immutable
data class Table(
  val id: TableId,
  val players: List<Player>,
) {
   fun seat(player: Player): Table {
       return copy(players = players + player)
   }
}
----

== Invariants 🚫

[source, kotlin]
----
class Table(
  val id: TableId,
  val players: MutableList<Player>, // mutable
  val config: TableConfig,
) {
   fun seat(player: Player) {
      with(config) {
        check(players.size in minPlayers..maxPlayers)
        check(players.distinctBy { it.tablePosition }.size == players.size)
      }
      players.add(player)
   }

   fun lastPlayerLeaves() {
      with(config) {
        check(players.size in config.minPlayers..config.maxPlayers)
      }
      players.removeLast()
   }
}
----

== Invariants 🚫

[source, kotlin]
----
data class Table(
    val id: TableId,
    val players: List<Player>, // immutable
    val config: TableConfig,
) {
   init {
     with(config) {
       check(players.size in minPlayers..maxPlayers)
       check(players.distinctBy { it.tablePosition }.size == players.size)
     }
   }

   fun seat(player: Player): Table =
      copy(players = players + player)

   fun lastPlayerLeaves(): Table =
      copy(players = players.dropLast(1))
}
----

== Null

* Kotlin, compilation ✅
* L'absence de présence

[source, kotlin]
----
data class RewardPoints(val value: Int)

// use case
interface RewardPlayer {
  fun endGameRewardFor(player: Player): RewardPoints?
}

...
rewardPlayer.endGameRewardFor(player) == null // 🤔
...
----

== Sealed interfaces/classes

NullObject pattern

[source, kotlin]
----
// use case
interface RewardPlayer {
  fun endGameRewardFor(player: Player): Reward
}

sealed interface Reward {
  data object NotEnoughGameTime : Reward
  data class PlayerNotElligible(reason: Reason) : Reward
  data class Points(val value: Int) : Reward
}
----

[%step]
[source, kotlin]
----
val reward = rewardPlayer.endGameRewardFor(player)
// exhaustive when
when (reward) {
  is NotEnoughGameTime -> println("Needs to play more!")
  is PlayerNotElligible -> println("Not eligible: $reason!")
  is Points -> println("Player won ${reward.value} points!")
  // no else, no default
}
----

== Value classes

* donner un sens métier aux valeurs
* fonctions opérateurs
* 🧮 commutatif, associatif, distributif
* 🔑 invariants

== Value classes 🪙

[source, kotlin]
----
@JvmInline
value class Chips(val value: Long) : Comparable<Chips> {
  init {
    require(value >= 0) { "Chips cannot be negative" }
  }

  operator fun plus(chips: Chips): Chips = 
    Chips(value + chips.value)
  operator fun minus(chips: Chips): Chips = 
    Chips(value - chips.value)
  operator fun times(factor: Int): Chips = 
    Chips(value * factor)
  override fun compareTo(other: Chips): Int = 
    value.compareTo(other.value)
}
----

[%step]
[source, kotlin]
----
123.chips >= 42.chips // true
123.chips in 100.chips..200.chips // true
123.chips + 42.chips == 165.chips
123.chips - 888.chips // 💥 IllegalArgumentException
----

== Value classes 🪙

[source, kotlin]
----
@JvmInline
value class Chips(val value: Long) : Comparable<Chips> {
  init {
    require(value >= 0) { "Chips cannot be negative" }
  }
  @Deprecated("Don't use div: splitBy()!", level = ERROR)
  operator fun div(divider: Int): Chips = 
    throw NotImplementedError()

  fun splitBy(divider: Int): WholeAndRemainder {
    require(divider > 0)
    val whole = Chips(value / divider)
    val remainder = Chips(value % divider)
    return WholeAndRemainder(whole, remainder)
  }
)
----

[%step]
image:div_deprecated.png[width=90%]

== Value classes 🪙

[source, kotlin]
----
fun split(pot: Chips, players: List<Player>)
    : Map<Player, Chips>
{
  val (whole, remainder) = pot.splitBy(players.size) // ✅
  return players.associateWith { whole } 
    + (players.last() to (whole + remainder))
}
----

[source, kotlin]
----
7 splitBy 3 == WholeAndRemainder(whole = 2, remainder = 1)

//             🧑‍🦰  👱🏾    🧑‍🦲
//            🟢🟢 🟢🟢 🟢🟢🟡
----

== Problématiques techniques

* Jeu temps réel
** Bidirectionnel 🌐 <--> 💻/📱
** Latence
** Animations, timings gérés par le serveur
* Optimisations infrastructure
** Réseau performant
** Nombreuses connections
** Rentabilité hardware

[.columns.is-vcentered]
== Jeu temps réel ⏲️

[.column]
image:grpc.png[width=80%]

*VS.*

[.column]
image:websockets.png[width=45%] +
WebSockets +

== Protocoles

|===
|gRPC |WebSockets 

|+ performance (binaire)
|- verbeux (JSON)

|- connu équipe (écosystème)
|+ familier équipe

|- navigateur (2023)
|+ tous clients

|- broadcast
|+ broadcast
|===

== Ktor

* ❌ Framework
* 🪶 Light
* ∥ Coroutines
* 📦 WebSocket server engines
* ⏭️ gRPC/protobuf

== AWS GameLift 🎮

* `Fleet` (cycle de vie & scaling des GameServers)
* `FlexMatch` (matchmaking des joueurs)

[%notitle]
== Architecture

image::poker-archi.drawio.png[background, size=contain]

== ➕/➖ instances

* icon:server[] × n Tables -> stateful
* Mise à l'échelle ?
* Rolling updates ?

== Rolling updates

++++
<html>
  <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    mermaid.initialize({ startOnLoad: true });
  </script>
  <body>
    <pre class="mermaid">
sequenceDiagram
    autonumber
    participant CI as CI/CD
    participant OLD as instance N
    participant FL as AWS Fleet
    CI ->> FL: v. N+1
    activate FL
    create participant NEW as instance N+1
    FL -->> NEW: 🆕
    FL -->> NEW: AVAILABLE
    activate NEW
    FL -->> OLD: Refresh instance + UNAVAILABLE
    deactivate FL
    activate OLD
    loop pour chaque table
      OLD -->> OLD: Laisse table se finir
      OLD ->> FL: Deregister table finie
    end
    OLD ->> FL: Termine instance
    deactivate OLD
    destroy OLD
    FL -->> OLD: ❌
    loop pour chaque table
      NEW -->> NEW: Démarre table
      NEW ->> FL: Register table prête
      deactivate NEW
    end
    </pre>
  </body>
</html>
++++

== RNG Service

== Flows

== CQRS

* Command Query Responsibility Segregation

== Table, Commands, Events

image:exposition-CQRS.png[width=70%]

== Timekeeper

== Optimisation Serveur (WS, Netty, Koin)

== Base de Données (DynamoDB -> PostgreSQL)

== Concurrence (non affinité)

== La vie réelle (mise en prod)

* 09/12/2023

== Les abus

== Critiques passagères

== Conclusion

image:early_app.png[width=30%]

[%notitle]
== Conclusion

image::table.jpg[background, size=contain]

[%notitle]
== Conclusion

video::desktop_demo.mov[width=100%, opts=autoplay,loop]

[%notitle]
== Conclusion

* 2 variantes, 3 🔜 4 modes de jeu
* Back office (emergencies, sanctions, ...)
* Prévention / Détection
** Fraude
** Collusion
** Bots
* Conformité audits ANJ, Data analytics
* Observabilité
* KPIs métier

== Cross-device frontend

* Flutter
** 📱 iOS, Android
** 🖥️ Windows, MacOS

== Chiffres

Donner des KPIs, avec l'accord de Cyril

[.columns.is-vcentered]
== Questions ?

[.column]
image:avatar.jpg[width=90%]

[.column.is-two-thirds]
*Nicolas Comet* +
Senior Staff Software Engineer +
image:betclic.png[width=55%] +
Poker ♣️♦️♠️♥️ +
icon:envelope[] nicolas.comet@gmail.com +
https://www.linkedin.com/in/nicolascomet[icon:linkedin[].com/nicolascomet] +
https://bsky.app/profile/ncomet.bsky.social[@ncomet.bsky.social] +
https://github.com/ncomet[icon:github[].com/ncomet] +

[%notitle]
== Votez 🙏

Vote